name: NodeJS with Grunt + Playwright

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  e2e:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]  # Node >=20 para compatibilidad con Angular

    steps:
    # 1Ô∏è‚É£ Checkout repo de tests
    - name: Checkout tests repo
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Clonar frontend
    - name: Clone frontend
      run: git clone https://github.com/jhonnierdlc/front-test.git front-test

    # 3Ô∏è‚É£ Clonar backend
    - name: Clone backend
      run: git clone https://github.com/jhonnierdlc/back-test.git back-test

    # 4Ô∏è‚É£ Instalar dependencias backend
    - name: Install backend dependencies
      run: |
        cd back-test
        npm install

    # 5Ô∏è‚É£ Levantar backend en segundo plano
    - name: Start backend
      run: |
        cd back-test
        npm run start &

    # 6Ô∏è‚É£ Instalar dependencias frontend
    - name: Install frontend dependencies
      run: |
        cd front-test
        npm install --legacy-peer-deps

    # 7Ô∏è‚É£ Build frontend
    - name: Build frontend
      run: |
        cd front-test
        npm run build

    # 8Ô∏è‚É£ Servir frontend de manera confiable
    - name: Serve frontend
      run: |
        cd front-test
        npm install -g serve wait-on
        serve -s dist/employee-app -l 4200 --single &
        npx wait-on http://localhost:4200 --timeout 60000

    # 9Ô∏è‚É£ Instalar dependencias de tests
    - name: Install test dependencies
      run: npm install --legacy-peer-deps

    # üîü Instalar navegadores de Playwright (soluciona Permission denied)
    - name: Install Playwright browsers
      run: npx playwright install

    # 1Ô∏è‚É£1Ô∏è‚É£ Ejecutar Playwright
    - name: Run Playwright tests
      run: npx playwright test --reporter=html

    # 1Ô∏è‚É£2Ô∏è‚É£ Subir reporte HTML
    - name: Upload Playwright report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
